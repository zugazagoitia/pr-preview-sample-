name: PR Preview
run-name: Preview of pr ${{ github.event.pull_request.number }} by ${{ github.event.pull_request.user.login }}

on:
  pull_request_target:
    types: [opened, reopened, synchronize, closed]

permissions:
  pull-requests: write
  contents: read


jobs:
  Build:
    runs-on: ubuntu-latest
    steps:

        # Create the comment to be updated
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### 👷 Deploy Preview for javalin.io processing.
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |

      - uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      # Build the site
      - name: Jekyll Actions 
        uses: helaili/jekyll-action@2.4.0 
        with: 
          build_only: true 
          build_dir: ./_site 

      - name: Install surge
        run: npm install -g surge
    
      - if: ${{ github.event.action != 'closed' }}
        name: Deploy to surge
        run: surge --project ./_site --token ${{ secrets.SURGE_TOKEN }} --domain javalin-pr-${{ github.event.pull_request.number }}-preview.surge.sh

      # Delete the preview when the PR is closed or merged
      - if: ${{ github.event.action == 'closed' }}
        name: Tear down surge
        run: surge teardown javalin-pr-${{ github.event.pull_request.number }}-preview.surge.sh --token ${{ secrets.SURGE_TOKEN }}

      # Update the comment if the pr was not closed
      - if: ${{ github.event.action != 'closed' }}
        name: comment Preview Ready
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### ✅ Deploy Preview for javalin.io ready!
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |
            | 🌐 Preview | https://javalin-pr-${{ github.event.pull_request.number }}-preview.surge.sh |
  
      # Delete the preview when the PR is closed or merged
      - if: ${{ github.event.action == 'closed' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### 🗑 Deploy Preview for javalin.io deleted.
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |

      - if: ${{ failure() }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### ❌ Deploy Preview for javalin.io failed.
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |


