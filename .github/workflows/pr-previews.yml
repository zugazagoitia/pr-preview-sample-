name: PR Preview
run-name: Preview of pr ${{ github.event.pull_request.number }} by ${{ github.event.pull_request.user.login }}

on:
  pull_request_target:
    types: [opened, reopened, synchronize, closed]

permissions:
  pull-requests: write
  contents: read


jobs:
  Deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.action != 'closed' }}
    steps:
        # Create the comment to be updated
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### 👷 Deploy Preview for javalin.io processing.
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |
            
      - uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          
      - name: Setup Node.js environment
        uses: actions/setup-node@v3.5.1
        
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true   

      - name: Build jekyll site
        run: jekyll build

      - name: Install surge
        run: npm install -g surge
    
      - name: Deploy to surge
        run: surge --project ./_site --token ${{ secrets.SURGE_TOKEN }} --domain javalin-pr-${{ github.event.pull_request.number }}-preview.surge.sh

      - name: comment Preview Ready
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### ✅ Deploy Preview for javalin.io ready!
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |
            | 🌐 Preview | https://javalin-pr-${{ github.event.pull_request.number }}-preview.surge.sh |
  

      - if: ${{ failure() }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### ❌ Deploy Preview for javalin.io failed.
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |

  Teardown:
    runs-on: ubuntu-latest
    if: ${{ github.event.action == 'closed' }}
    steps:
    
      - name: Setup Node.js environment
        uses: actions/setup-node@v3.5.1
        
      - name: Install surge
        run: npm install -g surge

      - name: Tear down surge
        run: surge teardown javalin-pr-${{ github.event.pull_request.number }}-preview.surge.sh --token ${{ secrets.SURGE_TOKEN }}

        # Delete the preview when the PR is closed or merged
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### 🗑 Deploy Preview for javalin.io deleted.
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |
      
      - if: ${{ failure() }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### ❌ Deploy Preview for javalin.io failed.
            | Name | Link |
            |-|-|
            | 🔨 Latest commit | ${{ github.event.pull_request.head.sha }} |
            | 🔍 Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |      


